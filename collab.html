<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network | Notes Zone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" href="logo.ico.ico" type="image/x-icon">
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    body { transition: background-color 0.3s, color 0.3s; }
    .glass-card {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .dark .glass-card {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .dark .glass-card:hover {
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .profile-img {
      width: 72px; height: 72px; border-radius: 9999px; object-fit: cover;
      border: 3px solid #38bdf8; background: #f1f5f9;
    }
    .dark .profile-img { border-color: #0ea5e9; background: #1e293b; }
    .role-badge {
      display: inline-flex; align-items: center; gap: 0.25rem;
      font-size: 0.85rem; border-radius: 9999px; padding: 0.25rem 0.75rem;
      background: #e0f2fe; color: #0369a1; margin-right: 0.25rem; margin-bottom: 0.25rem;
    }
    .dark .role-badge { background: #0c4a6e; color: #bae6fd; }
  </style>
</head>
<body class="bg-gradient-to-b from-sky-50 to-white dark:from-gray-900 dark:to-gray-800 text-gray-800 dark:text-gray-100 min-h-screen">
  <header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <a href="index.html" class="flex items-center gap-2">
        <img src="logo.png" alt="NotesZone Logo" class="h-10 w-auto">
      </a>
      <h1 class="text-2xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 text-transparent bg-clip-text">Network</h1>
      <button id="darkModeToggle" class="text-2xl focus:outline-none">🌙</button>
    </div>
  </header>
  <main class="container mx-auto px-4 py-8">
    <!-- Incoming Requests Section -->
    <div id="requestsSection" class="mb-8 hidden">
      <h3 class="text-xl font-bold mb-4 text-blue-700 dark:text-yellow-300 flex items-center gap-2"><i class="fas fa-user-friends"></i> Incoming Connection Requests <span id="requestsBadge" class="ml-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span></h3>
      <div id="requestsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>
    <div class="mb-8 flex flex-col sm:flex-row gap-4 items-center justify-between">
      <h2 class="text-3xl font-bold mb-2 sm:mb-0 bg-gradient-to-r from-blue-600 to-sky-500 text-transparent bg-clip-text">Connect with Notes Zone Users</h2>
      <input id="searchInput" type="text" placeholder="Search by name, skill, or role..." class="w-full sm:w-80 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-sky-500 focus:border-transparent">
    </div>
    <div id="profilesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
      <!-- User cards will be injected here -->
    </div>
    <div id="noResults" class="hidden text-center text-gray-500 dark:text-gray-400 mt-12">
      <i class="fas fa-users-slash text-3xl mb-2"></i>
      <p>No users found matching your search.</p>
    </div>
  </main>
  <!-- Chat Section (Modal) -->
  <div id="chatModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md flex flex-col h-[70vh]">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <img id="chatUserImg" src="" alt="Profile" class="w-10 h-10 rounded-full object-cover">
          <span id="chatUserName" class="font-bold text-lg"></span>
        </div>
        <button id="closeChat" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
      <form id="chatForm" class="flex items-center gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
        <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-sky-500 focus:border-transparent" autocomplete="off">
        <button type="submit" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    // Your Firebase config (reuse from profile.html)
    const firebaseConfig = {
      apiKey: "AIzaSyB-XawiwFbCOxyLpgNUIoW7MySWblx5zI8",
      authDomain: "notes-zone-2005.firebaseapp.com",
      projectId: "notes-zone-2005",
      storageBucket: "notes-zone-2005.firebasestorage.app",
      messagingSenderId: "729445577922",
      appId: "1:729445577922:web:4d87e4f19c37c32b13775b",
      measurementId: "G-9TER2ZYDCN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Helper: Get current user ID
    function getCurrentUserId() {
      return auth.currentUser ? auth.currentUser.uid : null;
    }

    // Fetch and render all users
    async function fetchAndRenderUsers() {
      const grid = document.getElementById('profilesGrid');
      const noResults = document.getElementById('noResults');
      grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading users...</div>';
      try {
        const snapshot = await db.collection('users').get();
        if (snapshot.empty) {
          grid.innerHTML = '';
          noResults.classList.remove('hidden');
          return;
        }
        const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderUsers(users);
      } catch (error) {
        grid.innerHTML = `<div class='col-span-full text-center py-8 text-red-500'><i class='fas fa-exclamation-circle mb-2 text-2xl'></i><p>Failed to load users.</p></div>`;
        noResults.classList.add('hidden');
      }
    }

    // Fetch connections for the current user
    async function fetchConnections() {
      const userId = getCurrentUserId();
      if (!userId) return {};
      const snapshot = await db.collection('connections').where('from', '==', userId).get();
      const connections = {};
      snapshot.forEach(doc => {
        connections[doc.data().to] = doc.data().status;
      });
      return connections;
    }

    // Chat Section Logic
    const chatModal = document.getElementById('chatModal');
    const chatUserImg = document.getElementById('chatUserImg');
    const chatUserName = document.getElementById('chatUserName');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const closeChat = document.getElementById('closeChat');
    let chatUnsub = null;
    let currentChatUser = null;
    let currentUserId = null;
    let connectedUserIds = [];

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join('_');
    }

    function openChatModal(user) {
      chatUserImg.src = user.profileImage || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
      chatUserName.textContent = user.name || 'Anonymous User';
      chatMessages.innerHTML = '';
      chatModal.classList.remove('hidden');
      currentChatUser = user;
      // Listen for messages
      if (chatUnsub) chatUnsub();
      const chatId = getChatId(currentUserId, user.id);
      chatUnsub = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot(snapshot => {
        chatMessages.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const isMe = msg.sender === currentUserId;
          const msgDiv = document.createElement('div');
          msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
          msgDiv.innerHTML = `<div class=\"max-w-xs px-4 py-2 rounded-lg ${isMe ? 'bg-sky-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'}\">${msg.text}</div>`;
          chatMessages.appendChild(msgDiv);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }
    closeChat.addEventListener('click', () => {
      chatModal.classList.add('hidden');
      if (chatUnsub) chatUnsub();
    });
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text || !currentChatUser) return;
      const chatId = getChatId(currentUserId, currentChatUser.id);
      await db.collection('chats').doc(chatId).collection('messages').add({
        sender: currentUserId,
        receiver: currentChatUser.id,
        text,
        read: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      chatInput.value = '';
    });
    // Enhance renderUsers to show Chat button only for connected users
    async function fetchConnectedUserIds() {
      const userId = getCurrentUserId();
      if (!userId) return [];
      const fromSnap = await db.collection('connections').where('from', '==', userId).where('status', '==', 'connected').get();
      const toSnap = await db.collection('connections').where('to', '==', userId).where('status', '==', 'connected').get();
      const fromIds = fromSnap.docs.map(doc => doc.data().to);
      const toIds = toSnap.docs.map(doc => doc.data().from);
      return Array.from(new Set([...fromIds, ...toIds]));
    }
    // Patch renderUsers to add Chat button for connected users
    async function renderUsers(users) {
      const grid = document.getElementById('profilesGrid');
      const noResults = document.getElementById('noResults');
      if (!users.length) {
        grid.innerHTML = '';
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');
      connectedUserIds = await fetchConnectedUserIds();
      grid.innerHTML = users.map(user => {
        if (user.id === currentUserId) return '';
        const isConnected = connectedUserIds.includes(user.id);
        return `
          <div class=\"glass-card p-6 rounded-xl flex flex-col items-center text-center\">
            <img src=\"${user.profileImage || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'}\" alt=\"Profile\" class=\"profile-img mb-3\">
            <h3 class=\"text-lg font-bold mb-1\">${user.name || 'Anonymous User'}</h3>
            <p class=\"text-gray-500 dark:text-gray-400 text-sm mb-2\">${user.bio ? user.bio.substring(0, 80) : 'No bio yet.'}</p>
            <div class=\"flex flex-wrap justify-center gap-1 mb-2\">
              ${(user.roles || []).map(role => `<span class='role-badge'><i class='fas fa-${role.icon}'></i> ${role.name}</span>`).join('')}
            </div>
            <div class=\"flex flex-wrap justify-center gap-1\">
              ${(user.skills || []).map(skill => `<span class='role-badge bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300'><i class='fas fa-star text-xs mr-1'></i> ${skill}</span>`).join('')}
            </div>
            <div class=\"flex justify-center gap-3 mt-3\">
              <button class=\"px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition connect-btn\" data-userid=\"${user.id}\" ${isConnected ? 'disabled' : ''}>${isConnected ? 'Connected' : 'Connect'}</button>
              ${isConnected ? `<button class=\"px-4 py-2 bg-sky-500 text-white rounded-full hover:bg-sky-600 transition chat-btn\" data-uid=\"${user.id}\"><i class=\"fas fa-comments mr-1\"></i>Chat</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
      // Add button click handlers
      document.querySelectorAll('.connect-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const targetUserId = btn.getAttribute('data-userid');
          const fromUserId = getCurrentUserId();
          if (!fromUserId) {
            alert('Please sign in to connect.');
            return;
          }
          btn.textContent = 'Pending';
          btn.disabled = true;
          await db.collection('connections').add({
            from: fromUserId,
            to: targetUserId,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      });
      document.querySelectorAll('.chat-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const uid = btn.getAttribute('data-uid');
          const user = users.find(u => u.id === uid);
          openChatModal(user);
        });
      });
    }
    // On auth state, set currentUserId
    auth.onAuthStateChanged(user => {
      if (user) currentUserId = user.uid;
    });

    // Search functionality
    let allUsers = [];
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const filtered = allUsers.filter(user => {
        const name = (user.name || '').toLowerCase();
        const bio = (user.bio || '').toLowerCase();
        const skills = (user.skills || []).join(' ').toLowerCase();
        const roles = (user.roles || []).map(r => r.name).join(' ').toLowerCase();
        return name.includes(query) || bio.includes(query) || skills.includes(query) || roles.includes(query);
      });
      renderUsers(filtered);
    });

    // Fetch incoming connection requests for the current user
    async function fetchIncomingRequests() {
      const userId = getCurrentUserId();
      if (!userId) return [];
      const snapshot = await db.collection('connections').where('to', '==', userId).where('status', '==', 'pending').get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // Render incoming requests
    async function renderRequests() {
      const section = document.getElementById('requestsSection');
      const grid = document.getElementById('requestsGrid');
      const badge = document.getElementById('requestsBadge');
      const userId = getCurrentUserId();
      if (!userId) {
        section.classList.add('hidden');
        return;
      }
      const requests = await fetchIncomingRequests();
      if (!requests.length) {
        section.classList.add('hidden');
        badge.classList.add('hidden');
        return;
      }
      section.classList.remove('hidden');
      badge.textContent = requests.length;
      badge.classList.remove('hidden');
      // Fetch user info for each request
      const userDocs = await Promise.all(requests.map(r => db.collection('users').doc(r.from).get()));
      grid.innerHTML = requests.map((req, i) => {
        const user = userDocs[i].data() || {};
        return `
          <div class="glass-card p-6 rounded-xl flex flex-col items-center text-center">
            <img src="${user.profileImage || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'}" alt="Profile" class="profile-img mb-3">
            <h3 class="text-lg font-bold mb-1">${user.name || 'Anonymous User'}</h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-2">${user.bio ? user.bio.substring(0, 80) : 'No bio yet.'}</p>
            <div class="flex justify-center gap-3 mt-3">
              <button class="px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition accept-btn" data-reqid="${req.id}">Accept</button>
              <button class="px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition reject-btn" data-reqid="${req.id}">Reject</button>
            </div>
          </div>
        `;
      }).join('');
      // Accept/Reject handlers
      document.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const reqId = btn.getAttribute('data-reqid');
          await db.collection('connections').doc(reqId).update({ status: 'connected' });
          renderRequests();
          auth.onAuthStateChanged(user => renderUsers(allUsers));
        });
      });
      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const reqId = btn.getAttribute('data-reqid');
          await db.collection('connections').doc(reqId).delete();
          renderRequests();
          auth.onAuthStateChanged(user => renderUsers(allUsers));
        });
      });
    }

    // Initial fetch and auth state
    auth.onAuthStateChanged(async user => {
      const grid = document.getElementById('profilesGrid');
      grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading users...</div>';
      try {
        const snapshot = await db.collection('users').get();
        allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderUsers(allUsers);
        renderRequests();
      } catch (error) {
        grid.innerHTML = `<div class='col-span-full text-center py-8 text-red-500'><i class='fas fa-exclamation-circle mb-2 text-2xl'></i><p>Failed to load users.</p></div>`;
      }
    });

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    const htmlElement = document.documentElement;
    darkModeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark');
      darkModeToggle.textContent = htmlElement.classList.contains('dark') ? '☀️' : '🌙';
    });
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      htmlElement.classList.add('dark');
      darkModeToggle.textContent = '☀️';
    }
  </script>
</body>
</html>
